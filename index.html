<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Omegle Clone</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Omegle Clone</h1>
  <div class="videos">
    <video id="myVideo" autoplay playsinline muted></video>
    <video id="partnerVideo" autoplay playsinline></video>
  </div>
  <button id="startBtn">Start</button>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="script.js"></script>
</body>
</html> background:black; border-radius:8px; }
    #chat { max-width:720px; margin:0 auto; margin-top:12px; background:#fff; border-radius:8px; padding:12px; box-shadow:0 2px 6px rgba(0,0,0,0.06);}
    #messages { min-height:100px; max-height:220px; overflow:auto; border:1px solid #eee; padding:8px; text-align:left; }
    #controls { display:flex; gap:8px; margin-top:8px; }
    input[type="text"] { flex:1; padding:8px; border-radius:4px; border:1px solid #ccc; }
    button { padding:8px 12px; border:none; border-radius:4px; cursor:pointer; }
    #sendBtn { background:#2b9a3e; color:#fff; }
    #reportBtn { background:#d9534f; color:#fff; }
    .msg-you { color:#0b5; font-weight:600; }
    .msg-partner { color:#111; font-weight:600; }
    #status { margin-top:6px; color:#666; font-size:14px; }
  </style>
</head>
<body>
  <h1>Anonymous Video Chat</h1>

  <div id="videos">
    <video id="localVideo" autoplay playsinline muted></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

  <div id="chat">
    <div id="status">Connecting...</div>
    <div id="messages"></div>
    <div id="controls">
      <input id="msgInput" placeholder="Type a message..." />
      <button id="sendBtn">Send</button>
      <button id="reportBtn">Report</button>
    </div>
  </div>

  <!-- Socket.IO client -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    // ********** CONFIG **********
    // Replace with your Render backend URL (include https://)
    const BACKEND_URL = "https://YOUR_RENDER_BACKEND_URL";

    // Optional: add TURN server credentials if you have one.
    const RTC_CONFIG = {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        // Example TURN (rate-limited/free test). Replace with your TURN or remove if you don't want it.
        {
          urls: "turn:relay1.expressturn.com:3478",
          username: "efYgDqH9fFGI6V",
          credential: "tHde5wUcq5hp8r"
        }
      ]
    };
    // ********** END CONFIG **********

    const socket = io(BACKEND_URL, { transports: ["websocket", "polling"] });

    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const messagesEl = document.getElementById("messages");
    const statusEl = document.getElementById("status");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");
    const reportBtn = document.getElementById("reportBtn");

    let localStream = null;
    let pc = null;

    function addMessage(who, text) {
      const d = document.createElement("div");
      d.innerHTML = `<span class="${who === 'You' ? 'msg-you' : 'msg-partner'}"><b>${who}:</b></span> ${text}`;
      messagesEl.appendChild(d);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // get camera + mic
    async function startLocalMedia() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;
        statusEl.innerText = "Waiting for partner...";
      } catch (err) {
        console.error("Cannot get user media:", err);
        statusEl.innerText = "Cannot access camera/mic. Allow permission and reload.";
      }
    }
    startLocalMedia();

    // Create and configure RTCPeerConnection
    function createPeerConnection() {
      if (pc) return pc;
      pc = new RTCPeerConnection(RTC_CONFIG);

      // add local tracks
      if (localStream) {
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
      }

      // when remote track arrives
      pc.ontrack = (e) => {
        remoteVideo.srcObject = e.streams[0];
      };

      // ice candidates
      pc.onicecandidate = (event) => {
        if (event.candidate) {
          socket.emit("webrtc-ice-candidate", event.candidate);
        }
      };

      pc.onconnectionstatechange = () => {
        console.log("PC state:", pc.connectionState);
        if (pc.connectionState === "connected") {
          statusEl.innerText = "Connected ✅";
        } else if (pc.connectionState === "disconnected" || pc.connectionState === "failed") {
          statusEl.innerText = "Disconnected";
        }
      };

      return pc;
    }

    // ---------- Socket events ----------
    socket.on("connect", () => {
      console.log("Connected to signaling server:", socket.id);
    });

    socket.on("waiting", (txt) => {
      statusEl.innerText = txt || "Waiting...";
    });

    // chatStart from backend: initiator true -> create offer
    socket.on("chatStart", async ({ initiator }) => {
      statusEl.innerText = "Partner found — starting WebRTC...";
      createPeerConnection();

      if (initiator) {
        try {
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);
          socket.emit("webrtc-offer", offer);
        } catch (err) {
          console.error("Offer error:", err);
        }
      }
    });

    socket.on("webrtc-offer", async (offer) => {
      createPeerConnection();
      try {
        await pc.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        socket.emit("webrtc-answer", answer);
      } catch (err) {
        console.error("Handle offer error:", err);
      }
    });

    socket.on("webrtc-answer", async (answer) => {
      try {
        await pc.setRemoteDescription(new RTCSessionDescription(answer));
      } catch (err) {
        console.error("Set remote answer error:", err);
      }
    });

    socket.on("webrtc-ice-candidate", async (candidate) => {
      try {
        if (candidate) {
          await pc.addIceCandidate(new RTCIceCandidate(candidate));
        }
      } catch (err) {
        console.error("Add ICE candidate error:", err);
      }
    });

    // Chat messages
    socket.on("message", (msg) => {
      addMessage("Partner", msg);
    });

    // UI events
    sendBtn.onclick = () => {
      const text = msgInput.value.trim();
      if (!text) return;
      socket.emit("message", text);
      addMessage("You", text);
      msgInput.value = "";
    };
    msgInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendBtn.click();
    });

    reportBtn.onclick = () => {
      const reason = prompt("Reason for reporting?");
      if (reason) socket.emit("report", reason);
    };
  </script>
</body>
</html>